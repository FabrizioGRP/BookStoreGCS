BookStore+
**********
<?xml version="1.0" encoding="utf-8"?>
<!--
  Para obtener más información acerca de cómo configurar la aplicación ASP.NET, visite
  https://go.microsoft.com/fwlink/?LinkId=301880
-->
<configuration>

	<!-- Conexión a la base de datos BookStoreDB -->
	<connectionStrings>
		<add name="SQL" connectionString="Data Source=localhost;Initial Catalog=BookStoreDB;Integrated Security=True;" providerName="System.Data.SqlClient" />
	</connectionStrings>

	<appSettings>
		<add key="webpages:Version" value="3.0.0.0" />
		<add key="webpages:Enabled" value="false" />
		<add key="ClientValidationEnabled" value="true" />
		<add key="UnobtrusiveJavaScriptEnabled" value="true" />
	</appSettings>

	<system.web>
		<compilation debug="true" targetFramework="4.7.2" />
		<httpRuntime targetFramework="4.7.2" />
	</system.web>

	<runtime>
		<assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1">
			<dependentAssembly>
				<assemblyIdentity name="Antlr3.Runtime" publicKeyToken="eb42632606e9261f" />
				<bindingRedirect oldVersion="0.0.0.0-3.5.0.2" newVersion="3.5.0.2" />
			</dependentAssembly>
			<dependentAssembly>
				<assemblyIdentity name="Microsoft.Web.Infrastructure" publicKeyToken="31bf3856ad364e35" />
				<bindingRedirect oldVersion="0.0.0.0-2.0.0.0" newVersion="2.0.0.0" />
			</dependentAssembly>
			<dependentAssembly>
				<assemblyIdentity name="Newtonsoft.Json" publicKeyToken="30ad4fe6b2a6aeed" />
				<bindingRedirect oldVersion="0.0.0.0-13.0.0.0" newVersion="13.0.0.0" />
			</dependentAssembly>
			<dependentAssembly>
				<assemblyIdentity name="System.Web.Optimization" publicKeyToken="31bf3856ad364e35" />
				<bindingRedirect oldVersion="1.0.0.0-1.1.0.0" newVersion="1.1.0.0" />
			</dependentAssembly>
			<dependentAssembly>
				<assemblyIdentity name="WebGrease" publicKeyToken="31bf3856ad364e35" />
				<bindingRedirect oldVersion="1.0.0.0-1.6.5135.21930" newVersion="1.6.5135.21930" />
			</dependentAssembly>
			<dependentAssembly>
				<assemblyIdentity name="System.Web.Helpers" publicKeyToken="31bf3856ad364e35" />
				<bindingRedirect oldVersion="1.0.0.0-3.0.0.0" newVersion="3.0.0.0" />
			</dependentAssembly>
			<dependentAssembly>
				<assemblyIdentity name="System.Web.WebPages" publicKeyToken="31bf3856ad364e35" />
				<bindingRedirect oldVersion="1.0.0.0-3.0.0.0" newVersion="3.0.0.0" />
			</dependentAssembly>
			<dependentAssembly>
				<assemblyIdentity name="System.Web.Mvc" publicKeyToken="31bf3856ad364e35" />
				<bindingRedirect oldVersion="1.0.0.0-5.2.9.0" newVersion="5.2.9.0" />
			</dependentAssembly>
		</assemblyBinding>
	</runtime>

	<system.codedom>
		<compilers>
			<compiler language="c#;cs;csharp" extension=".cs"
					  type="Microsoft.CodeDom.Providers.DotNetCompilerPlatform.CSharpCodeProvider, 
                      Microsoft.CodeDom.Providers.DotNetCompilerPlatform, 
                      Version=2.0.1.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35"
					  warningLevel="4"
					  compilerOptions="/langversion:default /nowarn:1659;1699;1701" />
			<compiler language="vb;vbs;visualbasic;vbscript" extension=".vb"
					  type="Microsoft.CodeDom.Providers.DotNetCompilerPlatform.VBCodeProvider, 
                      Microsoft.CodeDom.Providers.DotNetCompilerPlatform, 
                      Version=2.0.1.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35"
					  warningLevel="4"
					  compilerOptions="/langversion:default /nowarn:41008 /define:_MYTYPE=&quot;Web&quot; /optionInfer+" />
		</compilers>
	</system.codedom>

</configuration>

namespace BookStore.Entidades.Core
{
    public class Administrador
    {
        public int Id_Administrador { get; set; }
        public string Nombre { get; set; }
        public string Contraseña { get; set; }
    }
}

namespace BookStore.Entidades.Core
{
    public class Cliente
    {
        public int Id_Cliente { get; set; }
        public string Nombre { get; set; }
        public string Email { get; set; }
        public string Direccion { get; set; }
        public string Telefono { get; set; }
    }
}

namespace BookStore.Entidades.Core
{
    public class Libro
    {
        public int Id_Libro { get; set; }
        public string Titulo { get; set; }
        public string Autor { get; set; }
        public string ISBN { get; set; }
        public decimal Precio { get; set; }
        public int Stock { get; set; }
        public string Categoria { get; set; }
        public string Editorial { get; set; }
    }
}

using System.Data.SqlClient;
using BookStore.Entidades.Core;
using System.Configuration;

namespace BookStore.AccesoDatos.Core
{
    public class AdministradorDA
    {
        private readonly string cadenaConexion = ConfigurationManager.ConnectionStrings["SQL"].ConnectionString;

        public Administrador ValidarAdministrador(string nombre, string contraseña)
        {
            Administrador admin = null;

            using (SqlConnection cn = new SqlConnection(cadenaConexion))
            {
                string query = "SELECT * FROM Administrador WHERE Nombre = @nombre AND Contraseña = @contraseña";
                SqlCommand cmd = new SqlCommand(query, cn);
                cmd.Parameters.AddWithValue("@nombre", nombre);
                cmd.Parameters.AddWithValue("@contraseña", contraseña);

                cn.Open();
                SqlDataReader dr = cmd.ExecuteReader();

                if (dr.Read())
                {
                    admin = new Administrador
                    {
                        Id_Administrador = (int)dr["Id_Administrador"],
                        Nombre = dr["Nombre"].ToString(),
                        Contraseña = dr["Contraseña"].ToString()
                    };
                }
            }

            return admin;
        }
    }
}

using System.Data.SqlClient;
using BookStore.Entidades.Core;
using System.Configuration;

namespace BookStore.AccesoDatos.Core
{
    public class ClienteDA
    {
        private readonly string cadenaConexion = ConfigurationManager.ConnectionStrings["SQL"].ConnectionString;

        public Cliente ValidarCliente(string nombre, string email)
        {
            Cliente cliente = null;

            using (SqlConnection cn = new SqlConnection(cadenaConexion))
            {
                string query = "SELECT * FROM Cliente WHERE Nombre = @nombre AND Email = @correo";
                SqlCommand cmd = new SqlCommand(query, cn);
                cmd.Parameters.AddWithValue("@nombre", nombre);
                cmd.Parameters.AddWithValue("@correo", email);

                cn.Open();
                SqlDataReader dr = cmd.ExecuteReader();

                if (dr.Read())
                {
                    cliente = new Cliente
                    {
                        Id_Cliente = (int)dr["Id_Cliente"],
                        Nombre = dr["Nombre"].ToString(),
                        Email = dr["Email"].ToString(),
                        Direccion = dr["Direccion"] == DBNull.Value ? "" : dr["Direccion"].ToString(),
                        Telefono = dr["Telefono"] == DBNull.Value ? "" : dr["Telefono"].ToString()
                    };
                }
            }

            return cliente;
        }
    }
}

using System.Collections.Generic;
using System.Data.SqlClient;
using BookStore.Entidades.Core;
using System.Configuration;

namespace BookStore.AccesoDatos.Core
{
    public class LibroDA
    {
        private readonly string cadenaConexion = ConfigurationManager.ConnectionStrings["SQL"].ConnectionString;

        public List<Libro> ListarLibros()
        {
            List<Libro> lista = new List<Libro>();

            using (SqlConnection cn = new SqlConnection(cadenaConexion))
            {
                string query = "SELECT * FROM Libro";
                SqlCommand cmd = new SqlCommand(query, cn);
                cn.Open();
                SqlDataReader dr = cmd.ExecuteReader();

                while (dr.Read())
                {
                    lista.Add(new Libro
                    {
                        Id_Libro = (int)dr["Id_Libro"],
                        Titulo = dr["Titulo"].ToString(),
                        Autor = dr["Autor"] == DBNull.Value ? "" : dr["Autor"].ToString(),
                        ISBN = dr["ISBN"] == DBNull.Value ? "" : dr["ISBN"].ToString(),
                        Precio = (decimal)dr["Precio"],
                        Stock = (int)dr["Stock"],
                        Categoria = dr["Categoria"] == DBNull.Value ? "" : dr["Categoria"].ToString(),
                        Editorial = dr["Editorial"] == DBNull.Value ? "" : dr["Editorial"].ToString()
                    });
                }
            }

            return lista;
        }
    }
}

using BookStore.AccesoDatos.Core;
using BookStore.Entidades.Core;

namespace BookStore.LogicaNegocio.Core
{
    public class AdministradorLN
    {
        private readonly AdministradorDA adminDA = new AdministradorDA();

        public Administrador Login(string nombre, string contraseña)
        {
            return adminDA.ValidarAdministrador(nombre, contraseña);
        }
    }
}

using BookStore.AccesoDatos.Core;
using BookStore.Entidades.Core;

namespace BookStore.LogicaNegocio.Core
{
    public class ClienteLN
    {
        private readonly ClienteDA clienteDA = new ClienteDA();

        public Cliente Login(string nombre, string email)
        {
            return clienteDA.ValidarCliente(nombre, email);
        }
    }
}

using System.Collections.Generic;
using BookStore.AccesoDatos.Core;
using BookStore.Entidades.Core;

namespace BookStore.LogicaNegocio.Core
{
    public class LibroLN
    {
        private readonly LibroDA libroDA = new LibroDA();

        public List<Libro> ListarLibros()
        {
            return libroDA.ListarLibros();
        }
    }
}

using System.Web.Mvc;
using BookStore.LogicaNegocio.Core;
using BookStore.Entidades.Core;

namespace BookStore.Cliente.Web.Controllers
{
    public class LoginController : Controller
    {
        private readonly ClienteLN clienteLN = new ClienteLN();
        private readonly AdministradorLN adminLN = new AdministradorLN();

        [HttpGet]
        public ActionResult Index()
        {
            return View();
        }

        [HttpPost]
		public ActionResult Index(string tipo, string nombre, string email, string contraseña)
		{
    		if (tipo == "cliente")
    		{
        		var cliente = clienteLN.Login(nombre, email);
        		if (cliente != null)
        		{
            		Session["usuario"] = cliente;
            		Session["tipo"] = "cliente";
            		return RedirectToAction("ListaLibros", "Libro");
        		}
    		}
    		else if (tipo == "admin")
    		{
        		var admin = adminLN.Login(nombre, contraseña);
        		if (admin != null)
        		{
            		Session["usuario"] = admin;
            		Session["tipo"] = "admin";
            		return RedirectToAction("ListaLibros", "Libro");
        		}
    		}

    		ViewBag.Error = "Credenciales incorrectas.";
    		return View();
		}

		public ActionResult Logout()
		{
    		Session.Clear();
    		Session.Abandon();
    		return RedirectToAction("Index", "Login");
		}
    }
}

using System.Web.Mvc;
using BookStore.LogicaNegocio.Core;

namespace BookStore.Cliente.Web.Controllers
{
    public class LibroController : Controller
    {
        private readonly LibroLN libroLN = new LibroLN();

        public ActionResult ListaLibros()
		{
    		if (Session["usuario"] == null)
        		return RedirectToAction("Index", "Login");

    		var lista = libroLN.ListarLibros();
    		return View(lista);
		}
    }
}

@model IEnumerable<BookStore.Entidades.Core.Libro>

<h2>Lista de libros</h2>

<table class="table">
    <thead>
        <tr>
            <th>Título</th>
            <th>Autor</th>
            <th>Precio</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var libro in Model)
        {
            <tr>
                <td>@libro.Titulo</td>
                <td>@libro.Autor</td>
                <td>@libro.Precio</td>
            </tr>
        }
    </tbody>
</table>

@{
    ViewBag.Title = "Login - BookStore";
}

<h2 style="text-align:center;">Bienvenido a BookStore</h2>
<p style="text-align:center;">Inicie sesión como Cliente o Administrador</p>

<div style="display:flex; justify-content:space-around; margin-top:30px;">

    <!-- Login Cliente -->
    <div style="width:45%; border:1px solid #ccc; padding:20px; border-radius:10px;">
        <h3>Login Cliente</h3>
        @using (Html.BeginForm("Index", "Login", FormMethod.Post))
        {
            @Html.Hidden("tipo", "cliente")

            <div>
                <label>Nombre:</label><br />
                <input type="text" name="nombre" required class="form-control" />
            </div>
            <div>
                <label>Email:</label><br />
                <input type="email" name="email" required class="form-control" />
            </div>
            <br />
            <button type="submit" class="btn btn-primary">Ingresar</button>
        }
    </div>

    <!-- Login Administrador -->
    <div style="width:45%; border:1px solid #ccc; padding:20px; border-radius:10px;">
        <h3>Login Administrador</h3>
        @using (Html.BeginForm("Index", "Login", FormMethod.Post))
        {
            @Html.Hidden("tipo", "admin")

            <div>
                <label>Nombre:</label><br />
                <input type="text" name="nombre" required class="form-control" />
            </div>
            <div>
                <label>Contraseña:</label><br />
                <input type="password" name="contraseña" required class="form-control" />
            </div>
            <br />
            <button type="submit" class="btn btn-danger">Ingresar</button>
        }
    </div>

</div>

@if (ViewBag.Error != null)
{
    <div style="color:red; text-align:center; margin-top:20px;">
        @ViewBag.Error
    </div>
}

<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - BookStore+</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
</head>
<body>
    <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-dark bg-dark">
        <div class="container">
            @Html.ActionLink("Nombre de la aplicación", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
            <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" title="Alternar navegación" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse d-sm-inline-flex justify-content-between">
                <ul class="navbar-nav flex-grow-1">
                    <li>@Html.ActionLink("Inicio", "Index", "Home", new { area = "" }, new { @class = "nav-link" })</li>
                    <li>@Html.ActionLink("Acerca de", "About", "Home", new { area = "" }, new { @class = "nav-link" })</li>
                    <li>@Html.ActionLink("Contacto", "Contact", "Home", new { area = "" }, new { @class = "nav-link" })</li>
                    @if (Session["usuario"] != null)
                    {
                        <li>@Html.ActionLink("Cerrar sesión", "Logout", "Login", null, new { @class = "nav-link text-danger" })</li>
                    }
                </ul>
            </div>
        </div>
    </nav>
    <div class="container body-content">
        @RenderBody()
        <hr />
        <footer>
            <p>&copy; @DateTime.Now.Year - Mi aplicación ASP.NET</p>
        </footer>
    </div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    @RenderSection("scripts", required: false)
</body>
</html>
